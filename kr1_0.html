<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>knowledge representation model</title>
<style>
.d3-context-menu {
	position: absolute;
	display: none;
	background-color: #f2f2f2;
	border-radius: 4px;

	font-family: Arial, sans-serif;
	font-size: 14px;
	min-width: 150px;
	border: 1px solid #d4d4d4;

	z-index:1200;
}

.d3-context-menu ul {
	list-style-type: none;
	margin: 4px 0px;
	padding: 0px;
	cursor: default;
}

.d3-context-menu ul li {
	padding: 4px 16px;
}

.d3-context-menu ul li:hover {
	background-color: #4677f8;
	color: #fefefe;
}
.nodeLabel{
  fill: #000;
  font-family: sans-serif;
}
.link {
  stroke: #000;
  stroke-width: 1.5px;
}

.node {
  cursor: move;
  stroke:#000;
  stroke-width: 1.5px;
  stroke-dasharray:none;
}
.node.fixed {
  stroke-dasharray:10 3;
}
.node.selected {
  stroke:#f00;
}
.action{fill: #aaf;}
	
.agent{fill: #aaa;}
	
.region{fill: #bbb;}
.key_res{fill: #ccc;}
.attribute{fill: #ddd;}
.flag{fill: #eee;}
  
}
svg {
  height: 100%;
  max-width: 100%;
}
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}
#main-container{
	height: auto;
    width: 100%;
}
#menu{
  position: absolute;
  top:0;
  left: 0;
  height: 4%;
  max-width: 100%;
  background: #ffe;
}
#graph{
  position: absolute;
  top:30;
  height: 96%;
  max-width: 100%;
  bottom: 0;
  left:0;
  right:0;
  background: #fff;
}

</style>
<script src="d3.min.js"></script>
<script src="d3-context-menu.js" charset="utf-8"></script>
<script>
//global Kr informations
var infos =null; 
var agents =null;
var regions =null;
var key_rs=null;
var attributes=null;
var flags=null;
var actions=null;
var actions_binder=null;
var edges=null;
//graph layout
var link;//svg links
var node;//svg nodes
var nodes;//data nodes
var links;//data links
var vis;//svg
var force;//force layout
var drag;//drag function
var width = 960;
var height = 500;
var cpt=0;
var node_type=null;
var animate=false;
function merge(id1,id2){
	for(var i=0;i<edges.length;i++){
		if(edges[i].in_class[1]=="binder" && edges[i].in_path[0]==id2)
			edges[i].in_path[0]=id1;
		if(edges[i].out_class[1]=="binder" && edges[i].out_path[0]==id2)
			edges[i].out_path[0]=id1;
	}
	console.log(edges.length);
	edgesUnique();
	console.log("and now",edges.length);
	var newaction,oldaction,idx;
	for(var i=0;i<actions.length;i++){
		if(actions[i].name==id2){
			
			oldaction=actions[i];
			console.log("bla"+oldaction.context);
			idx=i;
		}
		if(actions[i].name==id1){
			
			newaction=actions[i];
			console.log("blo"+typeof newaction.context);
		}
	}
	var tmpctx=newaction.context;
	newaction.context=arrayUnique(tmpctx.concat(oldaction.context));
	actions.splice(idx,1);
	var oldnode=findNode(id2);
	var newnode=findNode(id1);
	for(var i=0;i<links.length;i++){
		if(links[i].source===oldnode)links[i].source=newnode;
		if(links[i].target===oldnode)links[i].target=newnode;
	}nodes.splice(findNodeIndex(id2),1);
	update();	
}
function arrayUnique(array) {
    var a = array.concat();
    for(var i=0; i<a.length; ++i) {
        for(var j=i+1; j<a.length; ++j) {
            if(a[i] === a[j])
                a.splice(j--, 1);
        }
    }

    return a;
}
function edgesUnique() {
    for(var i=0; i<edges.length; ++i) {
        for(var j=i+1; j<edges.length; ++j) {
            if((edges[i].in_path.join()==edges[j].in_path.join() && edges[i].out_path.join()==edges[j].out_path.join()) ||(edges[i].in_path.join()==edges[j].out_path.join() && edges[i].out_path.join()==edges[j].in_path.join()))
                edges.splice(j--, 1);
        }
    }
}
removeNodeLCG = function (id) {
        var i = 0;
        var n = findNode(id);
        while (i < links.length) {
            if ((links[i]['source'] === n)||(links[i]['target'] == n)) links.splice(i,1);
            else i++;
        }
        var index = findNodeIndex(id);
        if(index !== undefined) {
            nodes.splice(index, 1);
            update();
        }
    }
addNodeLCG = function (id) {
        nodes.push({"id":id});
        update();
}
function isInctx(id,ctx){
	for(var i=0;i<ctx.length;i++){
		if(ctx[i].el_path[ctx[i].el_path.length-1]==id) return true;
	}return false;
}
function updateCtx(act,node_l){
var ctx=[];
for(var i=0;i<node_l.length;i++){
var tmpcl;
var tmpp;
	if(node_l[i].type!="action"){
		tmpcl=["node",node_l[i].type];
		if(node_l[i].type!="agent"){
			tmpp=node_l[i].path.push(node_l[i].father.id);
		}
		else
			tmpp=[node_l[i].id];
	}
	else {
		tmpcl=["node","action","bind"];
		tmpp=[node_l[i].id];
	}
	ctx.push({"el_cl":tmpcl,"el_path":tmpp});
}
for(var i=0;i<actions.length;i++){
	if(actions[i].name==act){
		arrayUnique(actions[i].context.concat(ctx));
	}
}

}
function truncate(tab,index){
var res =[];
for(var i=0;i<tab.length-index;i++)
	res.push(tab[i]);
return res;
}
function toGraph(){
	for(var i=0;i<agents.length;i++){
		nodes.push({"id":agents[i].name,"type":agents[i].class[1],"x":agents[i].cx,"y":agents[i].cy,"path":[],"father":null,"values":[]});
	}for(var i=0;i<regions.length;i++){
		nodes.push({"id":regions[i].name,"type":regions[i].class[1],"x":0,"y":0,"path":[regions[i].ag_name],"father":regions[i].ag_name,"values":[]});
		links.push({"source": findNode(regions[i].ag_name), "target": findNode(regions[i].name)});
	}for(var i=0;i<key_rs.length;i++){
		nodes.push({"id":key_rs[i].name,"type":key_rs[i].class[1],"x":0,"y":0,"path":[key_rs[i].ag_name],"father":key_rs[i].ag_name,"values":[]});
		links.push({"source": findNode(key_rs[i].ag_name), "target": findNode(key_rs[i].name)});
	}for(var i=0;i<attributes.length;i++){
		nodes.push({"id":attributes[i].name,"type":attributes[i].class[1],"x":0,"y":0,"path":truncate(attributes[i].dest_path,1),"father":attributes[i].dest_path[attributes[i].dest_path.length-1],"values":attributes[i].values});
		links.push({"source": findNode(attributes[i].dest_path[attributes[i].dest_path.length-1]), "target": findNode(attributes[i].name)});
	}for(var i=0;i<flags.length;i++){
		nodes.push({"id":flags[i].name,"type":flags[i].class[1],"x":0,"y":0,"path":truncate(flags[i].dest_path,1),"father":flags[i].dest_path[flags[i].dest_path.length-1],"values":flags[i].values});
		links.push({"source": findNode(flags[i].dest_path[flags[i].dest_path.length-1]), "target": findNode(flags[i].name)});
	}for(var i=0;i<actions.length;i++){
		nodes.push({"id":actions[i].name,"type":actions[i].class[1],"x":0,"y":0,"path":[],"father":null,"values":[]});
	}for(var i=0;i<edges.length;i++){
		var tmp_src;
		var tmp_tar;
		if(edges[i].in_class[1] =="binder") tmp_src=edges[i].in_path[0];
		else tmp_src=edges[i].in_path[edges[i].in_path.length-1];
		if(edges[i].out_class[1] =="binder") tmp_tar=edges[i].out_path[0];
		else tmp_tar=edges[i].out_path[edges[i].out_path.length-1];
		links.push({"source": findNode(tmp_src), "target": findNode(tmp_tar)});
	}
	console.log(nodes);
	console.log(links);
	update();
}
function addNode(id,type,position,father,values,path){
	nodes.push({"id":id,"type":type,"x":position[0],"y":position[1],"path":path,"father":father,"values":values});
	switch(type){
		case "agent": agents.push({"class":["node","agent"],"name":id,"cx":position[0],"cy":position[1],"family":null,"abstract":false});
		break;
		case "region": regions.push({"class":["node","region"],"name":id,"ag_name":father.id,"color":"green"});
		break;
		case "key_rs": key_rs.push({"class":["node","key_r"],"name":id,"ag_name":father.id,"region_name":null,"angle":null});
		break;
		case "attr":attributes.push({"class":["node","attr"],"name":id,"dest_class":["node",father.type],"dest_path":father.path.push(father.id),"values":values});
		break;
		case "flag":flags.push({"class":["node","flag"],"name":id,"dest_class":["node",father.type],"dest_path":father.path.push(father.id),"values":values,"v_equiv":null})
		break;
		case "action":actions.push({"class":["node","action","bind"],"name":id,"context":[]});
		actions_binder.push({"class":["node","binder"],"name":"left","act_name":id});
		actions_binder.push({"class":["node","binder"],"name":"right","act_name":id});
		break;
	}
	animate=true;
	update();
}

addLink = function (sourceId, targetId) {
        var sourceNode = findNode(sourceId);
        var targetNode = findNode(targetId);
		
        if((sourceNode !== undefined) && (targetNode !== undefined)) {
            links.push({"source": sourceNode, "target": targetNode});
			edges.push({"class":["edge"],"in_class":["node",sourceNode.type],"in_path":sourceNode.path,"out_class":["node",targetNode.type],"out_path":targetNode.path});
			animate=true;
            update();
        }
}
addLink2 = function (sourceId, targetId,pol) {
        var sourceNode = findNode(sourceId);
        var targetNode = findNode(targetId);
        if((sourceNode !== undefined) && (targetNode !== undefined)) {
            links.push({"source": sourceNode, "target": targetNode});
			if(pol)
			edges.push({"class":["edge"],"in_class":["node",sourceNode.type],"in_path":sourceNode.path,"out_class":["node","binder"],"out_path":targetNode.path.push("left")});
			else edges.push({"class":["edge"],"in_class":["node",sourceNode.type],"in_path":sourceNode.path,"out_class":["node","binder"],"out_path":targetNode.path.push("right")});
			animate=true;
            update();
        }
}

var findNode = function (id) {
        for (var i=0; i < nodes.length; i++) {
            if (nodes[i].id === id)
                return nodes[i];
        };
}

var findNodeIndex = function (id) {
        for (var i=0; i < nodes.length; i++) {
            if (nodes[i].id === id)
                return i;
        };
}
var update = function(){
	link = vis.selectAll(".link")
		.data(links, function(d) { return d.source.id + "-" + d.target.id; });
        link.enter().insert("line")
            .classed("link",true);
        link.exit().remove();
	node = vis.selectAll("g.node")
			  .data(nodes, function(d) { return d.id;});
	var nodeEnter = node.enter().append("g")
            .classed("node",true)
			.on("contextmenu",d3.contextMenu(nodeMenu(),function(d){node_type=d.type;d3.event.stopPropagation();}))
			.on("click", clickHandler)
            .call(force.drag);
	nodeEnter.append("circle")
      .classed("node",true)
	  .classed("agent",function(d){return d.type=="agent"})
	  .classed("key_res",function(d){return d.type=="key_r"})
	  .classed("attribute",function(d){return d.type=="attr"})
	  .classed("flag",function(d){return d.type=="flag"})
	  .classed("region",function(d){return d.type=="region"})
	  .classed("action",function(d){return d.type=="action"})
      .attr("r", function(d){
		switch (d.type){
		case "agent": return 50;
		case "region": return 35;
		case "key_r": return 20;
		case "attr":return 12;
		case "flag":return 12;
		case "action":return 40;
		default: return 20;
		}})
      .call(drag);
	nodeEnter.append("text")
		.classed("nodeLabel",true)
		.attr("x", 0)
		.attr("dy", ".35em")
		.attr("text-anchor", "middle")
		.text(function(d) { return d.id; });
	node.exit().remove();
	force.on("tick",tick);
	force.start();
}
	
function tick(){
	link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
	node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}
function clickHandler(d) {
	if(d3.event.ctrlKey){
		d3.select(this).classed("fixed", d.fixed = false);
	}if(d3.event.shiftKey){
		if(d3.select(this).classed("selected"))
			d3.select(this).classed("selected", d.selected = false);
		else
			d3.select(this).classed("selected", d.selected = true);
	}	
}
function nodeMenu(){
	console.log(node_type);
	var menu=[{
				title: "add Attribute (NO ACTION)",
				action: function(elm,d,i){
					var tmpname="att"+(cpt++);
					console.log("att "+d.path);
					addNode(tmpname,"attr",[0,0],findNode(d.id),["a1","a2"],d.path);
					addLink(tmpname,d.id);
				}
			},{
				title: "add Flag (NO ACTION)",
				action: function(elm,d,i){
					var tmpname="flg"+(cpt++);
			
					addNode(tmpname,"flag",[0,0],findNode(d.id),["uphos","phos"],d.path);
					addLink(tmpname,d.id);
				}
			},{
				title: "add region (NO ACTION)",
				action: function(elm,d,i){
					var tmpname="reg"+(cpt++);
				
					console.log("reg "+d.path);
					addNode(tmpname,"region",[0,0],findNode(d.id),[],d.path);
					addLink(tmpname,d.id);
				}
			},{
				title: "add key residus (NO ACTION)",
				action: function(elm,d,i){
					var tmpname="res"+(cpt++);
				
					console.log(d.path);
					addNode(tmpname,"key_rs",[0,0],findNode(d.id),[],d.path);
					addLink(tmpname,d.id);
				}
			},{
				title: "add SelectedCtx (ONLY ACTION)",
				action: function(elm,d,i){
					updateCtx(d.id,d3.selectAll("g.node").filter(function(k){return k.selected==true}).data());
					vis.selectAll("g.node").classed("selected",function(d){ return d.selected=false});
				}
			},{
				title: "links right to (ONLY ACTION)",
				action: function(elm,d,i){
					selected=d3.selectAll("g.node").filter(function(k){return k.selected==true}).data()[0];
					addLink2(selected.id,d.id,false);
					updateCtx(d.id,[selected]);
					vis.selectAll("g.node").classed("selected",function(d){ return d.selected=false});
				}
				
			},{
				title: "links left to (ONLY ACTION)",
				action: function(elm,d,i){
					selected=d3.selectAll("g.node").filter(function(k){return k.selected==true}).data()[0];
					addLink2(selected.id,d.id,true);
					updateCtx(d.id,[selected]);
					vis.selectAll("g.node").classed("selected",function(d){ return d.selected=false});
				}
				
			},{
				title: "select Context (ONLY ACTION)",
				action: function(elm,d,i){
					vis.selectAll("g.node").classed("selected",function(d){ return d.selected=false});
					for(var i=0;i<actions.length;i++){
						if(actions[i].name==d.id)
							selected=d3.selectAll("g.node").filter(function(k){return isInctx(k.id,actions[i].context)}).classed("selected",function(d){ return d.selected=true});
					}
				}
				
			},{
				title: "Merge with (ONLY ACTION)",
				action: function(elm,d,i){
					selected=d3.selectAll("g.node").filter(function(k){return k.selected==true}).data()[0];
					merge(d.id,selected.id);
				}
				
			}];
	return menu;
}
function svgMenu(){
	var menu =[
			{
				title: "Unlock all",
				action: function(elm,d,i){
					vis.selectAll(".node").classed("fixed",function(d){ return d.fixed=false});
					force.resume();
				}
			},{
				title: "Select all",
				action: function(elm,d,i){
					vis.selectAll(".node").classed("selected",function(d){ return d.selected=true});
				}
			},{
				title: "Unselect all",
				action: function(elm,d,i){
					vis.selectAll(".node").classed("selected",function(d){ return d.selected=false});
				}
			},{
				title: "Add Agent",
				action: function(elm,d,i){
					var mousepos=d3.mouse(vis[0][0]);
					console.log(mousepos);
					addNode("ag"+(cpt++),"agent",mousepos,null,[],[]);
				}
					
			},{
				title: "Add Action",
				action: function(elm,d,i){
					var mousepos=d3.mouse(vis[0][0]);
					console.log(mousepos);
					addNode("act"+(cpt++),"action",mousepos,null,[],[]);
				}
					
			}
		];

	return menu;
}

function dragstart(d) {
	if(d3.select(this).classed("agent") || d3.select(this).classed("action"))
		d3.select(this).classed("fixed", d.fixed = true);
		animate=true;
}





//LCG informations
var arborescence=[];//mise en arbre de datas JSon
var lcg_agents=[];// ecrasement des agents en LCG
var lcg_actions=[];//action du LCG : regle avec membre droit/gauche/context.
//rules informations
var rules=[];//kappa rules : left, right (avec redondance)
var importJson = function(){//importe un fichier Json au format Kr
	d3.json("graph2.json",function(error, graph) {
		if (error) throw error;
		//console.log(graph);
		infos = graph.infos;
		//console.log(infos);
		agents =graph.agents;
		//console.log(agents);
		regions =graph.regions;
		//console.log(regions);
		key_rs=graph.key_rs;
		//console.log(key_rs);
		attributes=graph.attributes;
		//console.log(attributes);
		flags=graph.flags;
		//console.log(flags);
		actions=graph.actions;
		//console.log(actions);
		actions_binder=graph.actions_binder;
		//console.log(actions_binder);
		edges=graph.edges;
		//console.log(edges);
		width= d3.select("#graph").node().getBoundingClientRect().width;
		height = d3.select("#graph").node().getBoundingClientRect().height-30;//menu is 30px heigth
	console.log(width+" "+height);
vis=d3.select("#graph").append("svg:svg")
			.attr("width",width)
			.attr("height",height)
			.on("contextmenu",d3.contextMenu(svgMenu()))
force=d3.layout.force()
	.size([width,height])
	.linkDistance(function(d){if(d.source.type=="action" || d.target.type=="action") return 100; else{
	res1=0;
	switch (d.source.type){
		case "agent": res1= 50;break;
		case "region": res1= 35;break;
		case "key_rs": res1= 20;break;
		case "attr":res1= 12;break;
		case "flag":res1= 12;break;
		case "action":res1= 60;break;
		default: res1= 20;break;
		}switch (d.target.type){
		case "agent": return (50+res1)/2;
		case "region": return (35+res1)/2;
		case "key_rs": return (20+res1)/2;
		case "attr":return (12+res1)/2;
		case "flag":return (12+res1)/2;
		case "action":return (60+res1)/2;
		default: return (20+res1)/2;
		}
		
		
		
		}
	})
	.linkStrength(function(d){if(d.source.type=="action" || d.target.type=="action") return 0.7; else return 5})
	.charge(function(d){if(d.type=="action")return -300; else return -600});
	drag = force.drag()
    .on("dragstart", dragstart);
	
nodes=force.nodes();
links=force.links();
		update();
	toGraph();
	});
	
}
var exportJson = function(){//exporte une Kr au format Json
	var ret = "{"
			+"\"infos\":"
				+JSON.stringify(infos)
			+",\"agents\":"
				+JSON.stringify(agents)
			+",\"regions\":"
				+JSON.stringify(regions)
			+",\"key_rs\":"
				+JSON.stringify(key_rs)
			+",\"attributes\":"
				+JSON.stringify(attributes)	
			+",\"flags\":"
				+JSON.stringify(flags)	
			+",\"actions\":"
				+JSON.stringify(actions)
			+",\"actions_binder\":"
				+JSON.stringify(actions_binder)
			+",\"edges\":"
				+JSON.stringify(edges)
			+"}"
	;
	var url = 'data:text/json;charset=utf8,' + encodeURIComponent(ret);
	window.open(url, '_blank');
	window.focus();
}
var less = function(list,val){//supprime l'élément val de list
	var ret=[];
	if(list==null) return ret;
	for(var i=0;i<list.length;i++){
		if(list[i]!=val)
			ret.push(list[i]);
	}
	return ret;
}
var isIn = function(list,val){//retrouve une valeur dans une liste
	if(list==null)return false;
	for(var i=0;i<list.length;i++)
		return list[i]==val;
}
var isInObj = function(list,key,val){//retrouve une valeur dans une liste d'obj
	if(list==null)return false;
	for(var i=0;i<list.length;i++)
		return list[i][key]==val;
}
var setComKeyr = function(ag_name,reg_name){//définit pour une région donnée, les autres région avec des key-res en commun
	for(var i=0;i<key_rs.length;i++){
		if(key_rs[i].ag_name==ag_name && isIn(key_rs[i].region_name,reg_name))
			return less(key_rs[i].region_name,reg_name);
	}return [];
}
var getRegKeyFlg = function(ag_name,key_name){//récupère les flags des key res d'une region
	var ret=[];
	for(var i=0;i<flags.length;i++){
		if(flags[i].dest_class[0]=="node" && flags[i].dest_class[1]=="key_r" && flags[i].dest_path[0]==ag_name && flags[i].dest_path[1]==key_name)
			ret.push({"name":flags[i].name,"values":flags[i].values,"v_equiv":flags[i].v_equiv});
	}
	return ret;
}
var getRegKeyAtt = function(ag_name,key_name){//récupère les attribut des key res d'une région
	var ret=[];
	for(var i=0;i<attributes.length;i++){
		if(attributes[i].dest_class[0]=="node" && attributes[i].dest_class[1]=="key_r" && attributes[i].dest_path[0]==ag_name && attributes[i].dest_path[1]==key_name)
			ret.push({"name":attributes[i].name,"values":attributes[i].values});
	}
	return ret;
}
var getRegFlg = function(ag_name,reg_name){//récupère les flags d'une région
	var ret=[];
	for(var i=0;i<flags.length;i++){
		if(flags[i].dest_class[0]=="node" && flags[i].dest_class[1]=="region" && flags[i].dest_path[0]==ag_name && flags[i].dest_path[1]==reg_name)
			ret.push({"name":flags[i].name,"values":flags[i].values,"v_equiv":flags[i].v_equiv});
	}
	return ret;
}
var getRegAtt = function(ag_name,reg_name){//récupère les attributs d'une région
	var ret=[];
	for(var i=0;i<attributes.length;i++){
		if(attributes[i].dest_class[0]=="node" && attributes[i].dest_class[1]=="region" && attributes[i].dest_path[0]==ag_name && attributes[i].dest_path[1]==reg_name)
			ret.push({"name":attributes[i].name,"values":attributes[i].values});
	}
	return ret;
}
var getRegKey = function(ag_name,reg_name){//récupère les key résidus d'une régions
	var ret=[];
	for(var i=0;i<key_rs.length;i++){
		if(key_rs[i].ag_name==ag_name && isIn(key_rs[i].region_name,reg_name))
			ret.push({"name":key_rs[i].name,"att":getRegKeyAtt(ag_name,key_rs[i].name),"flags":getRegKeyFlg(ag_name,key_rs[i].name)});
	}
	return ret;
}
var getAgKeyFlg = function(ag_name,key_name){//récupère les flags des key-res d'un agent
	var ret=[];
	for(var i=0;i<flags.length;i++){
		if(flags[i].dest_class[0]=="node" && flags[i].dest_class[1]=="key_r" && flags[i].dest_path[0]==ag_name && flags[i].dest_path[1]==key_name)
			ret.push({"name":flags[i].name,"values":flags[i].values,"v_equiv":flags[i].v_equiv});
	}
	return ret;
}
var getAgKeyAtt = function(ag_name,key_name){//récupère les attributs des key-res d'un agent
	var ret=[];
	for(var i=0;i<attributes.length;i++){
		if(attributes[i].dest_class[0]=="node" && attributes[i].dest_class[1]=="key_r" && attributes[i].dest_path[0]==ag_name && attributes[i].dest_path[1]==key_name)
			ret.push({"name":attributes[i].name,"values":attributes[i].values});
	}
	return ret;
}
var getAgFlg = function(ag_name){//récupère les flags d'un agent
	var ret=[];
	for(var i=0;i<flags.length;i++){
		if(flags[i].dest_class[0]=="node" && flags[i].dest_class[1]=="agent" && flags[i].dest_path[0]==ag_name)
			ret.push({"name":flags[i].name,"values":flags[i].values,"v_equiv":flags[i].v_equiv});
	}
	return ret;
}
var getAgAtt =function(ag_name){//récupère les attributs d'un agent
	var ret=[];
	for(var i=0;i<attributes.length;i++){
		if(attributes[i].dest_class[0]=="node" && attributes[i].dest_class[1]=="agent" && attributes[i].dest_path[0]==ag_name)
			ret.push({"name":attributes[i].name,"values":attributes[i].values});
	}
	return ret;
}
var getAgKey = function(ag_name){//récupère les key_rs d'un agent
	var ret=[];
	for(var i=0;i<key_rs.length;i++){
		if(key_rs[i].ag_name==ag_name && key_rs[i].region_name==null)
			ret.push({"name":key_rs[i].name,"att":getAgKeyAtt(ag_name,key_rs[i].name),"flags":getAgKeyFlg(ag_name,key_rs[i].name)});
	}
	return ret;
}
var getReg = function(ag_name){//récupère les régions d'un agent
	var ret=[];
	for(var i=0;i<regions.length;i++){
		if(regions[i].ag_name==ag_name)
			ret.push({"name":regions[i].name,"keyr":getRegKey(ag_name,regions[i].name),"att":getRegAtt(ag_name,regions[i].name),"flags":getRegFlg(ag_name,regions[i].name),"key_com":setComKeyr(ag_name,regions[i].name)});
	}
	return ret;
}
var aggr_agents = function(){// créé l'arborescence 
	for(var i=0;i<agents.length;i++)
		arborescence.push({"name":agents[i].name,"reg":getReg(agents[i].name),"keyr":getAgKey(agents[i].name),"att":getAgAtt(agents[i].name),"flags":getAgFlg(agents[i].name)});	
}
var pretty_arbo = function(){//affiche l'arborescence des agents.
	for(var i1=0;i1<arborescence.length;i1++){
		console.log("Agent : "+arborescence[i1].name);
		console.log("	key_res :");
		for(var i2=0;i2<arborescence[i1].keyr.length;i2++){
			console.log("		"+arborescence[i1].keyr[i2].name);
			console.log("		Attr :");
			for(var i3=0;i3<arborescence[i1].keyr[i2].att.length;i3++){
				console.log("		"+arborescence[i1].keyr[i2].att[i3].name+" : "+arborescence[i1].keyr[i2].att[i3].values);	
			}console.log("		Flags :");
			for(var i3=0;i3<arborescence[i1].keyr[i2].flags.length;i3++){
				console.log("		"+arborescence[i1].keyr[i2].flags[i3].name+" : "+arborescence[i1].keyr[i2].flags[i3].values);
			}
		}console.log("	Attr :");
		for(var i2=0;i2<arborescence[i1].att.length;i2++){
			console.log("	"+arborescence[i1].att[i2].name+" : "+arborescence[i1].att[i2].values);
		}console.log("	Flags :");
		for(var i2=0;i2<arborescence[i1].flags.length;i2++){
			console.log("	"+arborescence[i1].flags[i2].name+" : "+arborescence[i1].flags[i2].values);
		}console.log("	regions :");
		for(var i2=0;i2<arborescence[i1].reg.length;i2++){
			console.log("	"+arborescence[i1].reg[i2].name);
			console.log("		Attr :");
			for(var i3=0;i3<arborescence[i1].reg[i2].att.length;i3++){
				console.log("		"+arborescence[i1].reg[i2].att[i3].name+" : "+arborescence[i1].reg[i2].att[i3].values);
			}console.log("		Flags :");
			for(var i3=0;i3<arborescence[i1].reg[i2].flags.length;i3++){
				console.log("		"+arborescence[i1].reg[i2].flags[i3].name+" : "+arborescence[i1].reg[i2].flags[i3].values);
			}
			console.log("		key_res :");
			for(var i3=0;i3<arborescence[i1].reg[i2].keyr.length;i3++){
				console.log("			"+arborescence[i1].reg[i2].keyr[i3].name);
				console.log("			Attr :");
				for(var i4=0;i4<arborescence[i1].reg[i2].keyr[i3].att.length;i4++){
					console.log("		"+arborescence[i1].reg[i2].keyr[i3].att[i4].name+" : "+arborescence[i1].reg[i2].keyr[i3].att[i4].values);
				}console.log("			Flags :");
				for(var i4=0;i4<arborescence[i1].reg[i2].keyr[i3].flags.length;i4++){
					console.log("		"+arborescence[i1].reg[i2].keyr[i3].flags[i4].name+" : "+arborescence[i1].reg[i2].keyr[i3].flags[i4].values);
				}
			}
		}
	}
}
var pretty_site = function(){//affiche les agents du LCG
	for(var i=0;i<lcg_agents.length;i++){
		console.log(lcg_agents[i].name);
		for(var j=0;j<lcg_agents[i].sites.length;j++){
			console.log("	"+lcg_agents[i].sites[j].name);
			console.log("	val : "+lcg_agents[i].sites[j].values.join(" "));
			console.log("	veq : "+lcg_agents[i].sites[j].v_equiv);
			for(var k=0;k<lcg_agents[i].sites[j].o_path.length;k++){
				console.log("	path : "+lcg_agents[i].sites[j].o_path[k].join("."));
			}
		}
	}
}
var genSite = function(agent){//créer les site pour tout les agents !
	var ret=[];
	if(agent.att!=null){
	for(var i=0;i<agent.att.length;i++){//créer un site par attribut multi-valué de l'agent
		if(agent.att[i].values.length>1)
			ret.push({
				"name":"at_"+agent.att[i].name,
				"values":agent.att[i].values,
				"v_equiv":null,
				"o_path":[[agent.name,agent.att[i].name]]
			});
	}}
	if(agent.flags!=null){
	for(var i=0;i<agent.flags.length;i++){//créer un site par flag de l'agent
			ret.push({
				"name":"fl_"+agent.flags[i].name,
				"values":agent.flags[i].values,
				"v_equiv":agent.flags[i].v_equiv,
				"o_path":[[agent.name,agent.flags[i].name]]
			});
	}}
	if(agent.keyr!=null){
	for(var i=0;i<agent.keyr.length;i++){//créer des sites pour chaque key res de l'agent
		for(var j=0;j<agent.keyr[i].att.length;j++){//créer un site pour chaque attribut (multi val) de chaque key res
			if(agent.keyr[i].att[j].values.length>1)
				ret.push({
					"name":"k_at_"+agent.keyr[i].name+"."+agent.keyr[i].att[j].name,
					"values":agent.keyr[i].att[j].values,
					"v_equiv":null,
					"o_path":[[agent.name,agent.keyr[i].name,agent.keyr[i].att[j].name]]
				});
		}for(var j=0;j<agent.keyr[i].flags.length;j++){//créer un site pour chaque flag de chaque key res
			ret.push({
				"name":"k_fl_"+agent.keyr[i].name+"."+agent.keyr[i].flags[j].name,
				"values":agent.keyr[i].flags[j].values,
				"v_equiv":agent.keyr[i].flags[j].v_equiv,
				"o_path":[[agent.name,agent.keyr[i].name,agent.keyr[i].flags[j].name]]
			});
		}
	}}
	if(agent.reg!=null){
	for(var i=0;i<agent.reg.length;i++){//créer les sites des régions de l'agent
		for(var j=0;j<agent.reg[i].att.length;j++){//pour chaque att multi val de région, créer site
			if(agent.reg[i].att[j].values.length>1)
				ret.push({
					"name":"r_at_"+agent.reg[i].name+"."+agent.reg[i].att[j].name,
					"values":agent.reg[i].att[j].values,
					"v_equiv":null,
					"o_path":[[agent.name,agent.reg[i].name,agent.reg[i].att[j].name]]
				});
		}
		for(var j=0;j<agent.reg[i].flags.length;j++){//pour chaque flag de région, créer site
			ret.push({
				"name":"r_fl_"+agent.reg[i].name+"."+agent.reg[i].flags[j].name,
				"values":agent.reg[i].flags[j].values,
				"v_equiv":null,
				"o_path":[[agent.name,agent.reg[i].name,agent.reg[i].flags[j].name]]
			});
		}
		var is_def=false;//verifie si la région a déja un site défini ou un equivalent
		for(var j=0;j<ret.length;j++){
			for(var k=0;k<ret[j].o_path;k++){
				if(ret[j].o_path[k].join(".")==(agent.name+"."+agent.reg[i].name))
					is_def=true;
			}
		}
		if(!is_def){//si la région n'est pas défini : on lui créé son site
			var tmp_path=[[agent.name,agent.reg[i].name]];
			if(agent.reg[i].key_com!=null){//si elle avait des equivalents, ils deviennent le sien !
				for(var k=0;k<agent.reg[i].key_com.length;k++){
					tmp_path.push([agent.name,agent.reg[i].key_com[k]]);
				}
			}
			ret.push({
				"name":"r_"+agent.reg[i].name,
				"values":[],
				"v_equiv":null,
				"o_path":tmp_path
			});
		}
		//on fait de même pour les key_r de la region
		for(var j=0;j<agent.reg[i].keyr.length;j++){
			for(var jj=0;jj<agent.reg[i].keyr[j].att.length;jj++){//attributs des key res de la region
				var is_def_att=false;//verifie si la région a déja un site défini pour les att du key_res ou un equivalent
				for(var k=0;k<ret.length;k++){
					for(var l=0;l<ret[k].o_path;l++){
						if(ret[k].o_path[l].join(".")==(agent.name+"."+agent.reg[i].name+"."+agent.reg[i].keyr[j].name+"."+agent.reg[i].keyr[j].att[jj].name));
							is_def_att = true;
					}
				}
				if(!is_def_att){
					var tmp_path=[[agent.name,agent.reg[i].name,agent.reg[i].keyr[j].name,agent.reg[i].keyr[j].att[jj].name]];//créer l'attribut en question
					if(agent.reg[i].key_com!=null){//si la region a des equivalents !
						for(var kk=0;kk<agent.reg[i].key_com.length;kk++){
							tmp_path.push([agent.name,agent.reg[i].key_com[k],agent.reg[i].keyr[j].name,agent.reg[i].keyr[j].att[jj].name]);
						}
					}
					ret.push({
						"name":"r_k_a_"+agent.reg[i].name+"."+agent.reg[i].keyr[j].name+"."+agent.reg[i].keyr[j].att[jj].name,
						"values":[],
						"v_equiv":null,
						"o_path":tmp_path
					});
				}
			}
			for(var jj=0;jj<agent.reg[i].keyr[j].flags.length;jj++){//flags des key res de la region
				var is_def_flg=false;//verifie si la région a déja un site défini pour les att du key_res ou un equivalent
				for(var k=0;k<ret.length;k++){
					for(var l=0;l<ret[k].o_path;l++){
						if(ret[k].o_path[l].join(".")==(agent.name+"."+agent.reg[i].name+"."+agent.reg[i].keyr[j].name+"."+agent.reg[i].keyr[j].flags[jj].name));
							is_def_flg = true;
					}
				}
				if(!is_def_flg){
					var tmp_path=[[agent.name,agent.reg[i].name,agent.reg[i].keyr[j].name,agent.reg[i].keyr[j].flags[jj].name]];//créer l'attribut en question
					if(agent.reg[i].key_com!=null){//si la region a des equivalents !
						for(var kk=0;kk<agent.reg[i].key_com.length;kk++){
							tmp_path.push([agent.name,agent.reg[i].key_com[k],agent.reg[i].keyr[j].name,agent.reg[i].keyr[j].flags[jj].name]);
						}
					}
					ret.push({
						"name":"r_k_f_"+agent.reg[i].name+"."+agent.reg[i].keyr[j].name+"."+agent.reg[i].keyr[j].flags[jj].name,
						"values":null,
						"v_equiv":null,
						"o_path":tmp_path
					});
				}
			}
		}
		
	}}
	return ret;
}
var regionToSite = function(){//génére les agents du LCG.
	for(var i=0;i<arborescence.length;i++){
		lcg_agents.push({"name":arborescence[i].name,"sites":genSite(arborescence[i])});
	}
}
var to_kappa_ag = function(){//génére la zone de signature
	var ret ="#### Signatures\n\n";
	for(var i=0;i<lcg_agents.length;i++){
		ret+=("%agent: "+(lcg_agents[i].name)+"(");
		for(var j=0;j<lcg_agents[i].sites.length;j++){
			ret+=lcg_agents[i].sites[j].name;
			if(lcg_agents[i].sites[j].values.length>=1) ret+="~";
			ret+=lcg_agents[i].sites[j].values.join("~");
			if(j<lcg_agents[i].sites.length-1)
				ret+=",";
		}
		ret+=")\n"
	}
	return ret+"\n";
}
var geneSEdges = function(){// créer les site de binding des agents (par défaut : pas de conflit)
	for(var i=0;i<edges.length;i++){
		if(edges[i].in_class[1]=="agent"){
			for(var j=0;j<lcg_agents.length;j++){
				if(lcg_agents[j].name==edges[i].in_path[0]){
					lcg_agents[j].sites.push({
						"name":"ei_"+i+"_"+lcg_agents[j].name,
						"values":[],
						"v_equiv":null,
						"o_path":[[lcg_agents[j].name]]
					});
				}
			}
		}
		if(edges[i].out_class[1]=="agent"){
			for(var j=0;j<lcg_agents.length;j++){
				if(lcg_agents[j].name==edges[i].out_path[0]){
					lcg_agents[j].sites.push({
						"name":"eo_"+i+"_"+lcg_agents[j].name,
						"values":[],
						"v_equiv":null,
						"o_path":[[lcg_agents[j].name]]
					});
				}
			}
		}
	}
}
var getValofCtx = function(ac_name,el_cl,el_nm){//recupère pour un element du context d'une action sa valeur pour l'action !
	var ret=[];
	//console.log("valofcont : "+ac_name+" : "+el_cl.join(".")+" : "+el_nm.join("."));
	for(var i=0;i<actions.length;i++){
		if(actions[i].name==ac_name){
			for(var j=0;j<actions[i].context.length;j++){
				if(actions[i].context[j].el_cl.join()==el_cl.join() && actions[i].context[j].el_path.join()==el_nm.join()){
					if(actions[i].context[j].el_value!=null)
						ret=actions[i].context[j].el_value;
				}	
			}
		}
	}
	return ret;
}
var getEdgesA = function(ac_name,dir){//renvoie le left ou right d'une action
	var ret=[];
	for(var i=0;i<edges.length;i++){
		if(edges[i].in_class[1]=="binder"){
			if(edges[i].in_path.join(".")==ac_name+"."+dir){
				ret.push({
					"path":elTrsl({"el_cl":edges[i].out_class,"el_path":edges[i].out_path},i),
					"val":getValofCtx(ac_name,edges[i].out_class,edges[i].out_path)
				});
			}
		}
		if(edges[i].out_class[1]=="binder"){
			if(edges[i].out_path.join(".")==ac_name+"."+dir){
				ret.push({
					"path":elTrsl({"el_cl":edges[i].in_class,"el_path":edges[i].in_path},i),
					"val":getValofCtx(ac_name,edges[i].in_class,edges[i].in_path)
				});
			}
		}
	}
	
	return ret;
}
var elTrsl = function(el_ctx,arc_id){//retourne le nouveau nom en LCG d'un element en fonction de l'ancien (sous forme de site !)
	if(el_ctx.el_cl[1]=="agent"){
		return [el_ctx.el_path[0],"ei_"+arc_id+"_"+el_ctx.el_path[0]];
	}
	else{
		for(var i=0;i<lcg_agents.length;i++){
			for(var j=0;j<lcg_agents[i].sites.length;j++){
				for(var k=0;k<lcg_agents[i].sites[j].o_path.length;k++){
					if(el_ctx.el_path.join(".")==lcg_agents[i].sites[j].o_path[k].join("."))
						return [lcg_agents[i].name,lcg_agents[i].sites[j].name];
				}
			}
		}
	}
	console.log("can't find : "+el_ctx.el_path.join("."));
	return null;//l'élément n'existe pas dans le lcg !
}
var pretty_act = function(){//affiche proprement les actions (avec membres !)
	console.log("LCG Actions");
	for(var i=0;i<lcg_actions.length;i++){
		console.log(lcg_actions[i].type+" "+lcg_actions[i].name+"\n");
		for(var j=0;j<lcg_actions[i].left.length;j++){
			console.log("left : "+lcg_actions[i].left[j].path.join(".")+" : "+lcg_actions[i].left[j].val.join(",")+"\n");
		}
		for(var j=0;j<lcg_actions[i].right.length;j++){
			console.log("right : "+lcg_actions[i].right[j].path.join(".")+" : "+lcg_actions[i].right[j].val.join(",")+"\n");
		}
		for(var j=0;j<lcg_actions[i].context.length;j++){
			if(lcg_actions[i].context[j].type=="action")
				console.log("context : "+lcg_actions[i].context[j].name+" : "+lcg_actions[i].context[j].val.join(",")+"\n");
			if(lcg_actions[i].context[j].type=="agent")
				console.log("context : "+lcg_actions[i].context[j].name+" : "+lcg_actions[i].context[j].val.join(",")+"\n");
			if(lcg_actions[i].context[j].type=="site")
				console.log("context : "+lcg_actions[i].context[j].name.join(",")+" : "+lcg_actions[i].context[j].val.join(",")+"\n");
		}
	}
}
var asEdge = function(el_n,act_n){//regarde si un edge existe pour un element de type agent
	var res=false;
	for(var i=0;i<edges.length;i++){
		if(edges[i].out_class[1]=="binder" && edges[i].out_path[0]==act_n && edges[i].in_class[1]=="agent" && edges[i].in_path.join()==el_n.join())
			res=true;
		if(edges[i].in_class[1]=="binder" && edges[i].in_path[0]==act_n && edges[i].out_class[1]=="agent" && edges[i].out_path.join()==el_n.join())
			res=true;
	}
	return res;
}
var asEdgeS = function(el_n,act_n){//regarde si un edge existe pour un element de type site
	var res=false;
	for(var i=0;i<edges.length;i++){
		if(edges[i].out_class[1]=="binder" && edges[i].out_path[0]==act_n && edges[i].in_path.join()==el_n.join())
			res=true;
		if(edges[i].in_class[1]=="binder" && edges[i].in_path[0]==act_n && edges[i].out_path.join()==el_n.join())
			res=true;
	}
	return res;
}
var LCGAct = function(action,type){//genere un triplet pour une action
	var ret;
	if(type == "mod")
		ret={"type":action.mods,"name":action.name,"left":[],"right":[],"context":[]};
	else
		ret={"type":type,"name":action.name,"left":[],"right":[],"context":[]};
	for(var i=0;i<actions_binder.length;i++){//génération de left er right
		if(actions_binder[i].act_name==action.name){
			if(actions_binder[i].name=="left"){
				ret.left=(getEdgesA(action.name,"left"));
			}
			if(actions_binder[i].name=="right"){
				ret.right=(getEdgesA(action.name,"right"));
			}
		}
	}
	for(var i=0;i<action.context.length;i++){//génération du context
		//console.log("finding in context : "+action.context[i].el_path.join("."));
		if(action.context[i].el_cl[1]=="action"){
			//console.log("pushing : "+action.context[i].el_path[0]);
			ret.context.push({
				"type":"action",
				"name":action.context[i].el_path[0],
				"val":[]
			});
		}
		else if(action.context[i].el_cl[1]=="agent"){
			if(!asEdge(action.context[i].el_path,action.name)){
				//console.log("pushing : "+action.context[i].el_path[0]);
				ret.context.push({
					"type":"agent",
					"name":action.context[i].el_path[0],
					"val":[]
				});
			}
		}
		else {
			if(!asEdgeS(action.context[i].el_path,action.name)){
				//console.log("translating : "+action.context[i].el_path.join("."));
				var n_el = elTrsl(action.context[i],-1);
				if(n_el!=null){
					//console.log("pushing : "+n_el.join("."));
					ret.context.push({
						"type":"site",
						"name":n_el,
						"val":action.context[i].el_value
					});
				}
			}
		}
	}
	return ret;
}
var actionTransform = function(){//traduit les actions en pseudo regles : LCG Action
	for(var i=0;i<actions.length;i++){
		lcg_actions.push(LCGAct(actions[i],actions[i].class[2]));
	}
}
var normal = function(ctx_list,rule_tab){//prend un context et renvoi une liste d'agent type lcg
	var ret =[];
	var finded=false;
	for(var i=0;i<ctx_list.length;i++){
		//console.log("in normal for ctx : "+ctx_list[i].type+" "+ctx_list[i].name);
		if(ctx_list[i].type=="action"){
			for(var j=0;j<rule_tab.length;j++){
				if(rule_tab[j].name[0]==ctx_list[i].name){
					for(var ii=0;ii<rule_tab[j].right.length;ii++){
						ret.push(rule_tab[j].right[ii]);
						finded=true;
					}
				}				
			}
			if(finded==false){
				console.log("the action : "+ctx_list[i].name+"is note defined yet");
			}
			//console.log("adding : act"+ctx_list[i].name);
		}
		else if(ctx_list[i].type=="agent"){
			ret.push({
				"name":ctx_list[i].name,
				"sites":[]
			});
			//console.log("adding : "+ctx_list[i].name);
		}
		else{
			ret.push({
				"name":ctx_list[i].name[0],
				"sites":[{
					"name":ctx_list[i].name[1],
					"values":ctx_list[i].val,
					"bindval":null
				}]
			});
			//console.log("adding : "+ctx_list[i].name[0]+" "+ctx_list[i].name[1]);
		}
	}
	
	return ret;
}
var normalE = function(l_r_el){//transforme une liste left right en agents
	var ret=[];
	for(var i=0;i<l_r_el.length;i++){
		console.log("pour : "+l_r_el[i]);
		ret.push({
				"name":l_r_el[i].path[0],
				"sites":[{
					"name":l_r_el[i].path[1],
					"values":l_r_el[i].val,
					"bindval":null
				}]
			});
	}
	return ret;
}
var binded = function(l_r_el){//prend un liste left right et renvoie une liste d'agent
	var ret=[];
	var bind_v=Math.floor(Math.random()*100);
	for(var i=0;i<l_r_el.length;i++){
		ret.push({
				"name":l_r_el[i].path[0],
				"sites":[{
					"name":l_r_el[i].path[1],
					"values":l_r_el[i].val,
					"bindval":bind_v
				}]
			});
	}
	//console.log("binding : "+ret[0].name+" to : "+ret[1].name);
	return ret;
}
var isInSite = function(site_list, site_l){//si un site est deja defini dans la liste des sites d'un agent
	var ret=-1;
	for(var i=0;i<site_list.length;i++){
		if(site_list[i].name==site_l[0].name && site_list[i].values.join()==site_l[0].values.join() && site_list[i].bindval==site_l[0].bindval)
		ret=i;
	}
	return ret;
}
var incrAc = function(l_r_el){//prend un element a incrementer et l'incremente de sa value
	var ret=[];
	for(var i=0;i<l_r_el.length;i++){
		ret.push({
				"name":l_r_el[i].path[0],
				"sites":[{
					"name":l_r_el[i].path[1],
					"values":["phos"],
					"bindval":null
				}]
			});
	}
	return ret;
}
var decrAc = function(l_r_el){//prend un element a incrementer et l'incremente de sa value
	var ret=[];
	for(var i=0;i<l_r_el.length;i++){
		ret.push({
				"name":l_r_el[i].path[0],
				"sites":[{
					"name":l_r_el[i].path[1],
					"values":["uphos"],
					"bindval":null
				}]
			});
	}
	return ret;
}
var pretty_ruler = function(rule){//affiche les agents du LCG
	console.log("prettyruller");
	for(var i=0;i<rule.length;i++){
		console.log("rule : "+rule[i].name);
		if(rule[i].sites!=null){
		for(var j=0;j<rule[i].sites.length;j++){
			console.log("	 : "+rule[i].sites[j].name);
			console.log("	 : "+rule[i].sites[j].values.join());
			if(rule[i].sites[j].bindval==null)
				console.log("	 : null");
			else
				console.log("	 : "+rule[i].sites[j].bindval);
		}
	}
	}
}
var	concatrules = function(){//concatene les regles Kappa
	for(var i=0;i<rules.length;i++){
		rules[i].left=concat(rules[i].left,rules[i].common);
		rules[i].right=concat(rules[i].right,rules[i].common);
	}
}
var inAg_l = function(ag,ag_l){
	for(var i=0;i<ag_l.length;i++){
		//console.log("names "+ag_l[i].name+" "+ag.name);
		if(ag_l[i].name==ag.name){
		//console.log("identique");
		return i;
		}
	}
	return -1;
}
var aggro = function(ag_l){
	var res=[];
	for(var i=0;i<ag_l.length;i++){
		var isn=inAg_l(ag_l[i],res);
		if(isn==-1 && ag_l[i].sites!=null && ag_l[i].sites.length>0){
			var tmp={"name":ag_l[i].name,
					"sites":[ag_l[i].sites[0]]
					};
			res.push(tmp);
		}else if(isn!=-1 && ag_l[i].sites!=null && ag_l[i].sites.length>0){
			console.log("the site : ");
			pretty_ruler([ag_l[i]]);
			res[isn].sites.push(ag_l[i].sites[0]);
		}
	}
	return res;
}
var aggrorules = function(){
	for(var i=0;i<rules.length;i++){
		rules[i].left=aggro(rules[i].left);
		rules[i].right=aggro(rules[i].right);
	}
}
var concat = function(l1,l2){//concatène deux listes
	var res=[];
	for(var i=0;i<l1.length;i++)
		res.push(l1[i]);
	for(var i=0;i<l2.length;i++)
		res.push(l2[i]);
	return res;
}
var genRules = function(action,rule_tab){//génére les règles Kappa pour une action
	var ret=rule_tab;
	if(action.type=="bind"){
		for(var i=0;i<action.left.length;i++){
			for(var j=0;j<action.right.length;j++){
				var common=normal(action.context,rule_tab);
				var left=normalE([action.left[i],action.right[j]]);
				var right=binded([action.left[i],action.right[j]]);
				var rule={
					"name":([action.name,i,j]),
					"common":common,
					"left":left,
					"right":right
				};
				ret.push(rule);
			}
		}
	}
	else if(action.type=="brk"){
		for(var i=0;i<action.left.length;i++){
			for(var j=0;j<action.right.length;j++){
				var rule={
					"name":([action.name,i,j]),
					"left":agr(normal(action.context,rule_tab),binded([action.left[i],action.right[j]])),
					"right":agr(normal(action.context,rule_tab),normalE([action.left[i],action.right[j]]))
				};
				ret.push(rule);
			}
		}	
	}
	else if(action.type=="incr"){
		for(var j=0;j<action.right.length;j++){
			console.log("action bind : "+action.name);
				var common=normal(action.context,rule_tab);
				//pretty_ruler(common);
				var left=normalE([action.right[j]]);
				//pretty_ruler(left);
				var right=incrAc([action.right[j]]);
				//pretty_ruler(right);
				//pretty_ruler(aggro(left.concat(common)));
			var rule={
				"name":([action.name,j]),
				"common":common,
				"left":left,
				"right":right
			};
			ret.push(rule);
		}		
	}
	else if(action.type=="decr"){
		for(var j=0;j<action.right.length;j++){
			var common=normal(action.context,rule_tab);
				
				//pretty_ruler(common);
				var left=normalE([action.right[j]]);
				//pretty_ruler(left);
				var right=decrAc([action.right[j]]);
				//pretty_ruler(right);
				//pretty_ruler(aggro(left.concat(common)));
			var rule={
				"name":([action.name,j]),
				"common":common,
				"left":left,
				"right":right
			};
			ret.push(rule);
		}	
	}
	else if(action.type=="synth"){
		console.log("no synth action yet");
	}
	else if(action.type=="rem"){
		console.log("no rem action yet");
	}
	return ret;
}
var lcgActToRules = function() {//traduit le LCG en regles !
	var res=[];
	for(var i=0;i<lcg_actions.length;i++){
		res=genRules(lcg_actions[i],res);
	}
	return res;
}
var nuggetView = function(){//mode édition de nugget	
}
var to_kappa_rules=function(){//génére les regles en fonction des actions !
	var ret="#### Rules \n";
	for(var i=0;i<rules.length;i++){
		ret+=("#"+rules[i].name.join("_")+"\n");
		for(var j=0;j<rules[i].left.length;j++){
			ret+=(rules[i].left[j].name+"(");
			for(var k=0;k<rules[i].left[j].sites.length;k++){
				ret+=(rules[i].left[j].sites[k].name);
				if(rules[i].left[j].sites[k].values!=null && rules[i].left[j].sites[k].values.length==1)
					ret+=("~"+rules[i].left[j].sites[k].values[0]);
				if(rules[i].left[j].sites[k].values!=null && rules[i].left[j].sites[k].values.length>1)
					console.log("no multistate agents");
				if(rules[i].left[j].sites[k].bindval!=null)
					ret+=("!"+rules[i].left[j].sites[k].bindval);
				if(k<rules[i].left[j].sites.length-1)
					ret+=",";
			}
			ret+=")";
			if(j<rules[i].left.length-1)
				ret+=",";
		}
		ret+=" -> ";
		for(var j=0;j<rules[i].right.length;j++){
			ret+=(rules[i].right[j].name+"(");
			for(var k=0;k<rules[i].right[j].sites.length;k++){
				ret+=(rules[i].right[j].sites[k].name);
				if(rules[i].right[j].sites[k].values!=null && rules[i].right[j].sites[k].values.length==1)
					ret+=("~"+rules[i].right[j].sites[k].values[0]);
				if(rules[i].right[j].sites[k].values!=null && rules[i].right[j].sites[k].values.length>1)
					console.log("no multistate agents");
				if(rules[i].right[j].sites[k].bindval!=null)
					ret+=("!"+rules[i].right[j].sites[k].bindval);
				if(k<rules[i].right[j].sites.length-1)
					ret+=",";
			}
			ret+=")";
			if(j<rules[i].right.length-1)
				ret+=",";
		}
		ret+=" @ 1 \n";
	}
	ret+="\n\n";
	return ret;
}
var to_kappa_var=function(){// generation des variables Kappa : à définir par l'utilisateur !
	var ret ="#### Variables\n";
	for(var i=0;i<lcg_agents.length;i++){//les quantités
		ret+=("%var: 'qtt_"+(lcg_agents[i].name)+"' 1000\n");
	}
	for(var i=0;i<lcg_agents.length;i++){//observr les agents vides
		ret+=("%obs: '"+(lcg_agents[i].name)+"' |"+(lcg_agents[i].name)+"(");
		for(var j=0;j<lcg_agents[i].sites.length;j++){
			ret+=lcg_agents[i].sites[j].name;
			if(j<lcg_agents[i].sites.length-1) ret+=",";
		}
		ret+=")|\n"
	}
	for(var i=0;i<rules.length;i++){
		ret+="%obs: ";
		ret+="'"+rules[i].name.join("_")+"' |";
		for(var j=0;j<rules[i].right.length;j++){
			ret+=(rules[i].right[j].name+"(");
			for(var k=0;k<rules[i].right[j].sites.length;k++){
				ret+=(rules[i].right[j].sites[k].name);
				if(rules[i].right[j].sites[k].values!=null && rules[i].right[j].sites[k].values.length==1)
					ret+=("~"+rules[i].right[j].sites[k].values[0]);
				if(rules[i].right[j].sites[k].values!=null && rules[i].right[j].sites[k].values.length>1)
					console.log("no multistate agents");
				if(rules[i].right[j].sites[k].bindval!=null)
					ret+=("!"+rules[i].right[j].sites[k].bindval);
				if(k<rules[i].right[j].sites.length-1)
					ret+=",";
			}
			ret+=")";
			if(j<rules[i].right.length-1)
				ret+=",";
		}
		ret+="|\n";
	}
	ret+="\n\n";
	return ret;
}
var to_kappa_init=function(){//generation des conditions initiales : à définir par l'utilsateur :::::::::::::::::::::::::::::: utiliser les attributs pour simplifier !
	var ret ="#### Initial conditions\n";
	for(var i=0;i<lcg_agents.length;i++){
		ret+=("%init: 'qtt_"+(lcg_agents[i].name)+"' "+(lcg_agents[i].name)+"()\n");
	}
	ret+="\n\n";
	return ret;
}
var kappaTranslate = function(){//propose un fichier kappa correspondant au LCG
	var ret=to_kappa_ag();
	ret+=to_kappa_rules();
	ret+=to_kappa_var();
	ret+=to_kappa_init();
	console.log(ret);
	ret=ret.replace(/\./g,'_');
	console.log(ret);	
	//var url = 'data:text;charset=utf8,' + encodeURIComponent(ret);
	var url = "http://dev.executableknowledge.org/try/index.html?&nb_events=1000&plot_points=1000&time_limit=2.0&model_text=" + encodeURIComponent(ret);
	window.open(url, '_blank');
	window.focus();
}
function loadJS(file) {
    // DOM: Create the script element
    var jsElm = document.createElement("script");
    // set the type attribute
    jsElm.type = "application/javascript";
    // make the script element load file
    jsElm.src = file;
    // finally insert the element to the body element in order to load the script
    document.body.appendChild(jsElm);
}


var lcgView = function(){//passe la kr en mode LCG :::::::::::::::::::::::::::::::::::::::::::::: WORK IN PROGRESS : Pas d'affichage du LCG pour le moment !
	aggr_agents();
	//console.log("pretty arbo");
	//pretty_arbo();
	regionToSite();
	//console.log("pretty lcg");
	//pretty_site();
	geneSEdges();
	console.log("pretty lcg+edges sites");
	//pretty_site();
	actionTransform();
	//console.log("pretty actions : ");
	//pretty_act();
	console.log("trying rules");
	console.log(rules);
	rules=lcgActToRules();
	concatrules();
	aggrorules();

}
</script>
  </head>
  <body>
    <div id="main-container">
      <div id="menu">
	<Form name="menu_f">
	  <input type="button" name="import" value="Import Data" onclick="importJson()">
	  <input type="button" name="export" value="Export Data" onclick="exportJson()">
	  <input type="button" name="nugget" value="Add Nugget" onclick="nuggetView()">
	  <input type="button" name="update" value="Update" onclick="viewUpdate()">
	  <input type="button" name="lcg" value="LCG" onclick="lcgView()">
	  <input type="button" name="kappa" value="To Kappa" onclick="kappaTranslate()">
	</form>
      </div>
      <div id="graph">
      </div>
    </div>
  </body>
</html>
